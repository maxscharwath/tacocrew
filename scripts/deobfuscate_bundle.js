const fs = require('fs');

// Read the bundle.js file
let content = fs.readFileSync('bundle.js', 'utf8');

// Step 1: Replace obfuscated string lookup functions with actual strings
// Based on context analysis, these functions map numbers to strings

// _1668924 / _3304620 - DOM and string operations
const stringLookupMap = {
  _1668924: new Map([
    [365, 'createElement'],
    [621, 'div'],
    [799, 'card border-'],
    [817, 'OrderData'],
    [703, 'data-order-id'],
    [577, 'getHours'],
    [810, 'getMinutes'],
    [677, 'status'],
    [634, 'innerHTML'],
    [583, '<div class="card-body"><h5 class="card-title">'],
    [352, '<button class="btn btn-sm btn-primary repeat-order-btn" onclick="repeatOrder('],
    [597, ')">Répéter la commande</button>'],
    [828, ''],
    [708, '</h5>'],
    [836, '<div class="alert alert-'],
    [800, '-subtle"><strong>'],
    [552, '-subtle">En route.</div>'],
    [429, '-subtle">Livré.</div>'],
    [544, '</p>'],
    [655, '<p class="card-subtitle text-end text-muted">Heure de retrait demandée: '],
    [572, ''],
    [780, '</p>'],
    [642, '<p class="card-subtitle text-end text-muted">Heure de livraison demandée: '],
    [778, 'requestedFor'],
    [769, '</p>'],
    [354, 'livraison'],
    [704, 'type'],
    [392, '<p class="card-text text-end"><strong>Total: '],
    [640, '<button class="btn btn-sm btn-warning repeat-order-btn" onclick="repeatOrder('],
  ]),
  a0_17364: new Map([
    [336, '<ul class="list-group list-group-flush">'],
    [637, 'tacos'],
    [632, 'Tacos'],
    [696, 'extras'],
    [560, 'boissons'],
    [730, 'Boissons'],
    [724, 'desserts'],
  ]),
  _391906: new Map([
    [514, 'pending'],
    [574, 'En attente de confirmation.'],
    [534, 'confirmed'],
    [601, 'emporter'],
    [792, 'ondelivery'],
    [595, 'En route.'],
    [434, 'delivered'],
    [594, 'Livré.'],
    [486, 'cancelled'],
    [450, 'État inconnu.'],
  ]),
  _11784915: new Map([
    [430, 'pour retrait'],
    [377, 'pour livraison'],
  ]),
  _3170210: new Map([
    [440, 'textContent'],
    [641, 'setItem'],
    [593, 'true'],
    [390, 'location'],
    [635, 'reload'],
  ]),
  _1388808: new Map([
    [823, 'length'],
    [831, 'https://nominatim.openstreetmap.org/search?'],
    [360, 'Switzerland'],
    [565, 'toString'],
    [737, 'address'],
    [613, 'Mozilla/5.0'],
    [656, 'json'],
    [694, 'error'],
    [589, 'replace'],
    [470, 'Chemin '],
    [459, 'Avenue '],
    [629, 'Place '],
    [353, 'Route '],
  ]),
};

// Replace function calls with actual strings
function replaceStringLookups(code, funcName, lookupMap) {
  const regex = new RegExp(`${funcName}\\((\\d+)\\)`, 'g');
  return code.replace(regex, (match, num) => {
    const numValue = parseInt(num);
    if (lookupMap.has(numValue)) {
      return `"${lookupMap.get(numValue)}"`;
    }
    return match;
  });
}

// Apply all string lookup replacements
Object.keys(stringLookupMap).forEach((funcName) => {
  content = replaceStringLookups(content, funcName, stringLookupMap[funcName]);
});

// Step 2: Replace obfuscated variable assignments
content = content.replace(/_3304620\s*=\s*_1668924/g, '');
content = content.replace(/_2269029\s*=\s*a0_17364/g, '');
content = content.replace(/_3113142\s*=\s*_3170210/g, '');
content = content.replace(/_9989818\s*=\s*_1388808/g, '');

// Step 3: Rename obfuscated variables based on context
const variableReplacements = {
  // Order card function variables
  _3937618: 'orderData',
  _3582845: 'orderItemsHtml',
  _4821971: 'orderCard',
  _7379560: 'itemsHtml',
  _472414: 'order',
  _6167822: 'currentHour',
  _2165547: 'currentMinute',
  _5614620: 'currentDay',
  _1996534: 'isBusinessHours',
  _3635958: 'canRepeatOrder',
  _1836650: 'orderStatus',
  _5966286: 'orderType',
  _2893479: 'deliveryType',

  // Other obfuscated variables throughout the file
  _6064893: 'extraId',
  _7293539: 'extraName',
  _4051149: 'extraPrice',
  _4767312: 'extraQuantity',
  _5688905: 'freeSauceId',
  _4707586: 'freeSauceName',
  _4981981: 'freeSauces',
  _4464762: 'csrfToken',
  _3447079: 'extraData',
  _5865212: 'response',
  _1470504: 'result',
  _3821399: 'error',
  _4767214: 'tacoSize',
  _3702857: 'prefix',
  _4246287: 'standardMeats',
  _15223349: 'premiumMeats',
  _5340277: 'restrictedItems',
  _4537280: 'meatType',
  _1259985: 'meatInput',
  _6156411: 'meatId',
  _2553108: 'restrictedId',
  _1352330: 'meatSlug',
  _2991954: 'restrictedSlug',
  _4740026: 'checkbox',
  _1415202: 'index',
  _2331192: 'csrfToken',
  _4091896: 'html',
  _2228644: 'event',
  _13656588: 'editButton',
  _4104918: 'tacoIndex',
  _2690183: 'csrfToken',
  _4806479: 'response',
  _3319025: 'data',
  _1545740: 'tacoSize',
  _15861891: 'meats',
  _5913165: 'garnitures',
  _1212562: 'sauces',
  _4801310: 'tacosNote',
  _5456612: 'checkbox',
  _5390561: 'meats',
  _2919463: 'garnitures',
  _13646940: 'sauces',
  _4151770: 'tacoSize',
  _5053201: 'checkbox',
  _2223868: 'quantityControl',
  _4208834: 'quantityInput',
  _5562037: 'maxMeats',
  _15164666: 'meat',
  _2816047: 'meatCheckbox',
  _1800046: 'meatRow',
  _5670229: 'quantityControl',
  _3707030: 'quantityInput',
  _1190898: 'garniture',
  _4829836: 'garnitureCheckbox',
  _5105213: 'sauce',
  _3093328: 'sauceCheckbox',
  _4531010: 'error',
  _4128560: 'event',
  _2983214: 'selectedTacoSize',
  _5810179: 'selectedMeats',
  _4279475: 'selectedSauces',
  _1882471: 'selectedGarnitures',
  _4863964: 'formData',
  _3210333: 'meatCheckbox',
  _4551296: 'meatValue',
  _4701294: 'meatRow',
  _3597691: 'quantityInput',
  _2343150: 'quantity',
  _3765629: 'csrfToken',
  _5772796: 'response',
  _3916439: 'html',
  _2273549: 'error',
  _13593625: 'extraCheckboxes',
  _2341805: 'csrfToken',
  _2622956: 'response',
  _1681894: 'selectedExtras',
  _2534218: 'extra',
  _2877287: 'extraCheckbox',
  _10093852: 'quantityControl',
  _6184293: 'freeSauceContainer',
  _5218442: 'select',
  _1537479: 'index',
  _5856007: 'select',
  _3482257: 'error',
  _4487055: 'freeSauceContainer',
  _6173340: 'extraId',
  _5661975: 'extraCheckbox',
  _3335983: 'extraCheckbox',
  _9627935: 'quantityControl',
  _2923242: 'freeSauceContainer',
  _5032782: 'select',
  _2612948: 'isChecked',
  _4402379: 'quantity',
  _4184102: 'extraId',
  _16517533: 'extraValue',
  _5714374: 'priceText',
  _3655970: 'price',
  _3818387: 'button',
  _2394003: 'quantityInput',
  _3080102: 'quantity',
  _1112221: 'extraCheckbox',
  _1401121: 'extraId',
  _5819295: 'extraValue',
  _3701350: 'priceText',
  _1720378: 'price',
  _6133766: 'extraId',
  _3215536: 'quantity',
  _5332090: 'isDevMode',
  _2201295: 'freeSauceContainer',
  _5358119: 'selects',
  _5222815: 'savedSelections',
  _3294348: 'select',
  _5980773: 'index',
  _4724481: 'sauceItem',
  _10683138: 'savedValue',
  _5942225: 'optionsHtml',
  _1075874: 'sauce',
  _3496827: 'selected',
  _4247596: 'extraId',
  _2110935: 'selects',
  _2671598: 'select',
  _548660: 'freeSauceCheckbox',
  _5440961: 'freeSauceSelect',
  _5232365: 'drinkCheckboxes',
  _9329247: 'drinkId',
  _1330422: 'drinkName',
  _5393734: 'drinkPrice',
  _2876931: 'drinkQuantity',
  _3860621: 'csrfToken',
  _2525962: 'drinkData',
  _2880450: 'response',
  _2337037: 'result',
  _4223432: 'error',
  _2039061: 'csrfToken',
  _3344223: 'response',
  _5133915: 'selectedDrinks',
  _5839348: 'drink',
  _3004714: 'drinkCheckbox',
  _2187122: 'quantityControl',
  _4498822: 'error',
  _1967006: 'drinkCheckbox',
  _4383964: 'quantityControl',
  _2321475: 'quantity',
  _4421765: 'drinkId',
  _2193412: 'drinkValue',
  _4845164: 'priceText',
  _3154546: 'button',
  _14562462: 'quantityInput',
  _3026104: 'quantity',
  _2132757: 'drinkId',
  _3881611: 'drinkCheckbox',
  _3302025: 'drinkValue',
  _2261264: 'priceText',
  _4740241: 'dessertCheckboxes',
  _4877569: 'dessertId',
  _5983730: 'dessertName',
  _4498168: 'dessertPrice',
  _1848116: 'dessertQuantity',
  _4452466: 'csrfToken',
  _15895237: 'dessertData',
  _5954986: 'response',
  _3801760: 'result',
  _1248463: 'error',
  _1152261: 'csrfToken',
  _4132809: 'response',
  _1049997: 'selectedDesserts',
  _3777478: 'dessert',
  _5620687: 'dessertCheckbox',
  _4614310: 'quantityControl',
  _3547958: 'error',
  _1504629: 'dessertCheckbox',
  _4540472: 'quantityControl',
  _1771294: 'quantity',
  _4421943: 'dessertId',
  _1927188: 'dessertValue',
  _2441373: 'priceText',
  _2994398: 'button',
  _6186605: 'quantityInput',
  _4345274: 'quantity',
  _2994107: 'dessertId',
  _3118142: 'dessertCheckbox',
  _2490159: 'dessertValue',
  _2501207: 'priceText',
  _1763247: 'event',
  _4745250: 'csrfToken',
  _1694643: 'response',
  _1211815: 'html',
  _3926110: 'error',
  _6125221: 'event',
  _2854133: 'selectedTacoSize',
  _3013056: 'selectedMeats',
  _4415895: 'selectedSauces',
  _3001469: 'selectedGarnitures',
  _2276648: 'csrfToken',
  _8643420: 'meatQuantities',
  _3465613: 'meatCheckbox',
  _2628951: 'meatValue',
  _1503096: 'meatRow',
  _4203143: 'quantityInput',
  _1752037: 'quantity',
  _14895121: 'serializedData',
  _2944964: 'meatValue',
  _3801159: 'html',
  _3227763: 'event',
  _2009102: 'tacoIndex',
  _4842622: 'csrfToken',
  _2152082: 'result',
  _4042053: 'event',
  _5183569: 'finalizeButton',
  _4255311: 'originalButtonText',
  _3339720: 'transactionId',
  _3219489: 'csrfToken',
  _6079496: 'formData',
  _6028208: 'response',
  _5906034: 'data',
  _3394689: 'text',
  _2647563: 'orderResult',
  _3536995: 'collapseElement',
  _1330354: 'orderStories',
  _3447885: 'successMessage',
  _4629265: 'error',
  _2130111: 'addToHomeText',
  _1244769: 'bannerLogo',
  _6530307: 'userAgent',
  _5983123: 'text',
  _2376747: 'imageSrc',
  _4556735: 'event',
  _5461540: 'freeSauceContainer',
  _4818973: 'extraId',
  _6969877: 'extraCheckbox',
  _4219443: 'quantityInput',
  _5350605: 'quantity',
  _2834943: 'extraValue',
  _3640555: 'priceText',
  _4132495: 'price',
  _5903691: 'sauceSelects',
  _3834157: 'selectedSauces',
  _5593578: 'select',
  _6013764: 'sauceName',
  _4591531: 'selectProduct',
  _4507035: 'meatCheckboxes',
  _1342095: 'sauceCheckboxes',
  _4462310: 'garnitureCheckboxes',
  _3328778: 'checkedMeats',
  _2337475: 'checkbox',
  _3792886: 'totalMeatPortions',
  _5386943: 'meatCheckbox',
  _4794482: 'meatRow',
  _6212539: 'quantityInput',
  _2524386: 'quantity',
  _4698393: 'meatCheckbox',
  _1265063: 'meatCheckbox',
  _1621223: 'meatRow',
  _3063417: 'quantityInput',
  _2208944: 'currentQuantity',
  _3497315: 'maxAllowed',
  _1302631: 'meatCheckbox',
  _5662295: 'meatRow',
  _5128772: 'quantityControl',
  _8400322: 'quantityInput',
  _3103067: 'increaseButton',
  _1917109: 'quantityInput',
  _3186115: 'quantity',
  _1393664: 'decreaseButton',
  _8996724: 'quantityInput',
  _14188882: 'quantity',
  _2996197: 'sauceCheckbox',
  _4357644: 'checkbox',
  _4046888: 'checkbox',
  _2844035: 'checkbox',
  _3501110: 'checkbox',
  _4028114: 'tacoSize',
  _2039249: 'checkbox',
  _1630997: 'quantityControl',
  _4667796: 'quantityInput',
  _1573194: 'checkbox',
  _3348401: 'checkbox',
  _3238841: 'checkbox',
  _2881479: 'quantityControl',
  _13842231: 'quantityInput',
  _4322318: 'meatCheckbox',
  _2980856: 'meatRow',
  _4958554: 'quantityControl',
  _4088754: 'maxMeats',
  _3582460: 'quantityInput',
  _5165765: 'increaseButton',
  _3726235: 'quantityInput',
  _1146455: 'quantity',
  _4302412: 'decreaseButton',
  _4282008: 'quantityInput',
  _4494431: 'quantity',
  _4092632: 'timeSelect',
  _4515715: 'warningBanner',
  _3056176: 'warningMessage',
  _4407521: 'hasInitialized',
  _7423318: 'selectedTime',
  _6105121: 'orderModal',
  _6029459: 'timeSelect',
  _1416472: 'csrfToken',
  _1955099: 'response',
  _1126833: 'data',
  _4148974: 'option',
  _5315192: 'timeValue',
  _15213341: 'timeVariants',
  _7728503: 'isHighDemand',
  _7388221: 'timeVariant',
  _1279817: 'originalText',
  _4856414: 'error',
  _11161623: 'selectedTime',
  _5698237: 'csrfToken',
  _4781190: 'response',
  _4907603: 'data',
  _7640707: 'error',
  _5934625: 'error',
  _6203567: 'stockCache',
  _2045528: 'cacheTimestamp',
  _5675222: 'CACHE_DURATION',
  _4756369: 'currentTime',
  _8699378: 'response',
  _2526135: 'stockData',
  _1404761: 'error',
  _12058058: 'category',
  _3748186: 'itemId',
  _1570084: 'stockItem',
  _5197195: 'meatInput',
  _5875919: 'isAvailable',
  _3888577: 'labelElement',
  _14760805: 'containerElement',
  _11812765: 'outOfStockText',
  _5858141: 'outOfStockSpan',
  _3092769: 'garnitureInput',
  _12512801: 'isAvailable',
  _6237059: 'labelElement',
  _2665508: 'outOfStockText',
  _3414219: 'outOfStockSpan',
  _1977076: 'sauceInput',
  _12322112: 'isAvailable',
  _3180877: 'labelElement',
  _768285: 'outOfStockText',
  _2654346: 'outOfStockSpan',
  _5466237: 'dessertInput',
  _1129490: 'isAvailable',
  _3978110: 'labelElement',
  _5689327: 'outOfStockText',
  _1662062: 'outOfStockSpan',
  _5002235: 'drinkInput',
  _1160196: 'isAvailable',
  _2300368: 'labelElement',
  _5681983: 'outOfStockText',
  _3385397: 'outOfStockSpan',
  _10505989: 'extraInput',
  _4795566: 'isAvailable',
  _1537637: 'labelElement',
  _5929593: 'outOfStockText',
  _16583551: 'outOfStockSpan',
  _4083458: 'modal',
  _538022: 'addressInput',
  _4534685: 'autocompleteDropdown',
  _3772549: 'debounceTimer',
  _3653971: 'activeIndex',
  _4407269: 'suggestions',
  _1899987: 'postalCodeElement',
  _2539118: 'postalCodeMatch',
  _2528888: 'index',
  _4030418: 'item',
  _13965057: 'itemIndex',
  _5960606: 'suggestion',
  _2334339: 'streetName',
  _11764406: 'houseNumber',
  _1603517: 'addressParts',
  _6091245: 'lastPart',
  _7322574: 'isNumeric',
  _3833729: 'selectionEnd',
  _3271003: 'inputValue',
  _4516721: 'postalCode',
  _3979091: 'results',
  _2416321: 'street',
  _4385409: 'postalCode',
  _9989818: 'stringLookup',
  _1401742: 'normalizedStreet',
  _3706067: 'street',
  _2055809: 'lookup',
  _2363565: 'replacements',
  _8493057: 'pattern',
  _2720651: 'replacement',
  _2817176: 'normalized',
  _1394117: 'apiUrl',
  _4563294: 'response',
  _3951932: 'error',
  _4351184: 'results',
  _3934711: 'currentPostalCode',
  _4157589: 'uniqueAddresses',
  _1601089: 'result',
  _5859867: 'streetName',
  _5526654: 'resultPostalCode',
  _6003580: 'resultA',
  _2454905: 'resultB',
  _4475441: 'suggestion',
  _2039606: 'index',
  _4813994: 'itemElement',
  _5082911: 'streetName',
  _3107158: 'houseNumber',
  _5029560: 'fullAddress',
  _12076131: 'event',
  _4884713: 'event',
  _1953012: 'event',
  _5451072: 'items',
  _3984313: 'event',
};

// Apply variable replacements
Object.keys(variableReplacements).forEach((oldName) => {
  const regex = new RegExp(`\\b${oldName}\\b`, 'g');
  content = content.replace(regex, variableReplacements[oldName]);
});

// Step 4: Format the code (basic prettification)
// Convert bracket notation to dot notation where safe
content = content.replace(/(\w+)\["([^"]+)"\]/g, '$1.$2');
content = content.replace(/(\w+)\['([^']+)'\]/g, '$1.$2');

// Fix boolean values
content = content.replace(/\b!0\b/g, 'true');
content = content.replace(/\b!1\b/g, 'false');
content = content.replace(/\b!true\b/g, 'false');
content = content.replace(/\b!false\b/g, 'true');

// Write the deobfuscated file
fs.writeFileSync('bundle.js', content);
